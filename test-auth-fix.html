<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Supabase 认证修复测试</h1>
    
    <div id="auth-status" class="status info">
        认证状态: 未登录
    </div>

    <div class="test-section">
        <h2>1. Supabase 认证测试</h2>
        <div>
            <input type="email" id="email" placeholder="邮箱" value="test@example.com">
            <input type="password" id="password" placeholder="密码" value="password123">
        </div>
        <div>
            <button onclick="signUp()">注册</button>
            <button onclick="signIn()">登录</button>
            <button onclick="signOut()">登出</button>
            <button onclick="getSession()">获取会话</button>
        </div>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. API 端点测试</h2>
        <div>
            <button onclick="testUserProfile()">测试用户档案</button>
            <button onclick="testUserFiles()">测试文件列表</button>
            <button onclick="testHealth()">测试健康检查</button>
        </div>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. 文件上传测试</h2>
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
        <button onclick="uploadFile()">上传文件</button>
        <div id="upload-result" class="result"></div>
    </div>

    <script>
        // 初始化 Supabase 客户端
        const supabaseUrl = 'https://eybfrryonupkvjhzfwaw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YmZycnlvbnVwa3ZqaHpmd2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNzg0OTQsImV4cCI6MjA2ODY1NDQ5NH0.Pz9bxwzJG0LP5yE5H4AEW6WFiCXuf0SlRg0jwS2Cmaw';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const API_BASE = `${supabaseUrl}/functions/v1/make-server-54a8f580`;

        let currentSession = null;

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function updateAuthStatus(status) {
            const element = document.getElementById('auth-status');
            element.textContent = `认证状态: ${status}`;
        }

        // 监听认证状态变化
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session);
            currentSession = session;
            
            if (session) {
                updateAuthStatus(`已登录 - ${session.user.email}`);
            } else {
                updateAuthStatus('未登录');
            }
        });

        // 获取当前会话
        async function getSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    showResult('auth-result', `获取会话失败: ${error.message}`, true);
                } else {
                    showResult('auth-result', session ? 
                        `会话有效!\n用户: ${session.user.email}\nToken: ${session.access_token.substring(0, 50)}...` : 
                        '无有效会话');
                }
            } catch (error) {
                showResult('auth-result', `错误: ${error.message}`, true);
            }
        }

        // 注册
        async function signUp() {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            firstName: 'Test',
                            lastName: 'User',
                            visaCategory: 'EB-1A'
                        }
                    }
                });

                if (error) {
                    showResult('auth-result', `注册失败: ${error.message}`, true);
                } else {
                    showResult('auth-result', `注册成功!\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showResult('auth-result', `注册错误: ${error.message}`, true);
            }
        }

        // 登录
        async function signIn() {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    showResult('auth-result', `登录失败: ${error.message}`, true);
                } else {
                    showResult('auth-result', `登录成功!\n用户: ${data.user.email}\nToken: ${data.session.access_token.substring(0, 50)}...`);
                }
            } catch (error) {
                showResult('auth-result', `登录错误: ${error.message}`, true);
            }
        }

        // 登出
        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    showResult('auth-result', `登出失败: ${error.message}`, true);
                } else {
                    showResult('auth-result', '登出成功!');
                }
            } catch (error) {
                showResult('auth-result', `登出错误: ${error.message}`, true);
            }
        }

        // API 调用辅助函数
        async function apiCall(endpoint, options = {}) {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                throw new Error('请先登录');
            }

            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API 错误 ${response.status}: ${errorText}`);
            }

            return response.json();
        }

        // 测试用户档案
        async function testUserProfile() {
            try {
                const result = await apiCall('/user/profile');
                showResult('api-result', `用户档案获取成功:\n${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                showResult('api-result', `用户档案获取失败: ${error.message}`, true);
            }
        }

        // 测试文件列表
        async function testUserFiles() {
            try {
                const result = await apiCall('/user/files');
                showResult('api-result', `文件列表获取成功:\n${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                showResult('api-result', `文件列表获取失败: ${error.message}`, true);
            }
        }

        // 测试健康检查
        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                showResult('api-result', `健康检查结果:\n${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                showResult('api-result', `健康检查失败: ${error.message}`, true);
            }
        }

        // 文件上传测试
        async function uploadFile() {
            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showResult('upload-result', '请选择一个文件', true);
                    return;
                }

                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    showResult('upload-result', '请先登录', true);
                    return;
                }

                const fileId = 'test-' + Date.now();
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fileId', fileId);
                formData.append('userId', session.user.id);

                showResult('upload-result', '正在上传文件...');

                const response = await fetch(`${API_BASE}/upload/file`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('upload-result', `文件上传成功!\n${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    showResult('upload-result', `文件上传失败 ${response.status}: ${errorText}`, true);
                }
            } catch (error) {
                showResult('upload-result', `文件上传错误: ${error.message}`, true);
            }
        }

        // 页面加载时获取会话状态
        window.addEventListener('load', () => {
            getSession();
        });
    </script>
</body>
</html>