<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>数据库调试工具 - 文件持久化检查</h1>
    
    <div id="connection-status" class="status info">
        数据库连接状态: 检查中...
    </div>

    <div class="section">
        <h2>1. 直接数据库查询</h2>
        <p>直接查询 Supabase 数据库中的 kv_store 表</p>
        <div>
            <button onclick="checkDatabaseConnection()">检查数据库连接</button>
            <button onclick="queryKVStore()">查询 KV Store 表</button>
            <button onclick="queryUserFiles()">查询用户文件数据</button>
        </div>
        <div id="db-result" class="result"></div>
    </div>

    <div class="section">
        <h2>2. API 数据调试</h2>
        <p>通过 API 查询用户数据和文件列表</p>
        <div>
            <input type="text" id="userToken" placeholder="用户 Token" value="demo-token-user123">
            <button onclick="setTestToken()">设置测试 Token</button>
        </div>
        <div>
            <button onclick="debugUserProfile()">调试用户档案</button>
            <button onclick="debugUserFiles()">调试用户文件</button>
            <button onclick="debugTimeline()">调试时间线</button>
        </div>
        <div id="api-result" class="result"></div>
    </div>

    <div class="section">
        <h2>3. 数据写入测试</h2>
        <p>测试数据是否能正确写入和读取</p>
        <div>
            <input type="text" id="testKey" placeholder="测试键名" value="test_file_user123">
            <input type="text" id="testValue" placeholder="测试数据" value='{"name":"test.pdf","size":1024}'>
            <button onclick="writeTestData()">写入测试数据</button>
            <button onclick="readTestData()">读取测试数据</button>
            <button onclick="deleteTestData()" class="danger">删除测试数据</button>
        </div>
        <div id="write-result" class="result"></div>
    </div>

    <div class="section">
        <h2>4. 模拟文件上传流程</h2>
        <p>完整模拟文件上传和保存过程</p>
        <div>
            <button onclick="simulateFileUpload()">模拟文件上传</button>
            <button onclick="checkUploadedFile()">检查上传的文件</button>
            <button onclick="clearAllTestData()" class="danger">清除所有测试数据</button>
        </div>
        <div id="upload-result" class="result"></div>
    </div>

    <script>
        // 配置
        const supabaseUrl = 'https://eybfrryonupkvjhzfwaw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5YmZycnlvbnVwa3ZqaHpmd2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNzg0OTQsImV4cCI6MjA2ODY1NDQ5NH0.Pz9bxwzJG0LP5yE5H4AEW6WFiCXuf0SlRg0jwS2Cmaw';
        const API_BASE = `${supabaseUrl}/functions/v1/make-server-54a8f580`;
        
        // 创建 Supabase 客户端
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentToken = 'demo-token-user123';

        function showResult(elementId, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.className = `result ${type}`;
        }

        function updateConnectionStatus(status, type = 'info') {
            const element = document.getElementById('connection-status');
            element.textContent = `数据库连接状态: ${status}`;
            element.className = `status ${type}`;
        }

        // 检查数据库连接
        async function checkDatabaseConnection() {
            try {
                // 测试基本连接
                const { data, error } = await supabase
                    .from('kv_store_54a8f580')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    updateConnectionStatus(`连接失败: ${error.message}`, 'error');
                    showResult('db-result', `数据库连接错误:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    updateConnectionStatus('连接成功', 'success');
                    showResult('db-result', `数据库连接成功!\n表中共有 ${data} 条记录`);
                }
            } catch (error) {
                updateConnectionStatus(`连接异常: ${error.message}`, 'error');
                showResult('db-result', `连接异常:\n${error.message}`, 'error');
            }
        }

        // 查询 KV Store 表
        async function queryKVStore() {
            try {
                const { data, error } = await supabase
                    .from('kv_store_54a8f580')
                    .select('*')
                    .limit(20);
                
                if (error) {
                    showResult('db-result', `查询错误:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult('db-result', `KV Store 表数据 (最近20条):\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showResult('db-result', `查询异常:\n${error.message}`, 'error');
            }
        }

        // 查询用户文件数据
        async function queryUserFiles() {
            try {
                const { data, error } = await supabase
                    .from('kv_store_54a8f580')
                    .select('*')
                    .like('key', '%user_files_%');
                
                if (error) {
                    showResult('db-result', `查询用户文件错误:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult('db-result', `用户文件数据:\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showResult('db-result', `查询用户文件异常:\n${error.message}`, 'error');
            }
        }

        // 设置测试 Token
        function setTestToken() {
            currentToken = document.getElementById('userToken').value;
            showResult('api-result', `Token 已设置: ${currentToken}`);
        }

        // API 调用辅助函数
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`,
                    ...options.headers
                }
            });

            const result = await response.json();
            
            return {
                status: response.status,
                ok: response.ok,
                data: result
            };
        }

        // 调试用户档案
        async function debugUserProfile() {
            try {
                const result = await apiCall('/user/profile');
                showResult('api-result', 
                    `用户档案调试结果:\n状态: ${result.status}\n响应: ${JSON.stringify(result.data, null, 2)}`,
                    result.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `用户档案调试错误:\n${error.message}`, 'error');
            }
        }

        // 调试用户文件
        async function debugUserFiles() {
            try {
                const result = await apiCall('/user/files');
                showResult('api-result', 
                    `用户文件调试结果:\n状态: ${result.status}\n响应: ${JSON.stringify(result.data, null, 2)}`,
                    result.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `用户文件调试错误:\n${error.message}`, 'error');
            }
        }

        // 调试时间线
        async function debugTimeline() {
            try {
                const result = await apiCall('/user/timeline');
                showResult('api-result', 
                    `时间线调试结果:\n状态: ${result.status}\n响应: ${JSON.stringify(result.data, null, 2)}`,
                    result.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `时间线调试错误:\n${error.message}`, 'error');
            }
        }

        // 写入测试数据
        async function writeTestData() {
            try {
                const key = document.getElementById('testKey').value;
                const value = JSON.parse(document.getElementById('testValue').value);
                
                const { error } = await supabase
                    .from('kv_store_54a8f580')
                    .upsert({ key, value });
                
                if (error) {
                    showResult('write-result', `写入失败:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult('write-result', `数据写入成功!\n键: ${key}\n值: ${JSON.stringify(value, null, 2)}`);
                }
            } catch (error) {
                showResult('write-result', `写入异常:\n${error.message}`, 'error');
            }
        }

        // 读取测试数据
        async function readTestData() {
            try {
                const key = document.getElementById('testKey').value;
                
                const { data, error } = await supabase
                    .from('kv_store_54a8f580')
                    .select('value')
                    .eq('key', key)
                    .maybeSingle();
                
                if (error) {
                    showResult('write-result', `读取失败:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else if (data) {
                    showResult('write-result', `数据读取成功!\n键: ${key}\n值: ${JSON.stringify(data.value, null, 2)}`);
                } else {
                    showResult('write-result', `未找到数据!\n键: ${key}`, 'warning');
                }
            } catch (error) {
                showResult('write-result', `读取异常:\n${error.message}`, 'error');
            }
        }

        // 删除测试数据
        async function deleteTestData() {
            try {
                const key = document.getElementById('testKey').value;
                
                const { error } = await supabase
                    .from('kv_store_54a8f580')
                    .delete()
                    .eq('key', key);
                
                if (error) {
                    showResult('write-result', `删除失败:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult('write-result', `数据删除成功!\n键: ${key}`);
                }
            } catch (error) {
                showResult('write-result', `删除异常:\n${error.message}`, 'error');
            }
        }

        // 模拟文件上传流程
        async function simulateFileUpload() {
            try {
                const userId = 'user123';
                const fileId = 'test-file-' + Date.now();
                const fileName = 'test-document.pdf';
                
                // 步骤1: 创建单个文件记录
                const fileRecord = {
                    id: fileId,
                    userId: userId,
                    name: fileName,
                    size: 1024,
                    type: 'application/pdf',
                    uploadedAt: new Date().toISOString(),
                    status: 'uploaded',
                    ocrStatus: 'completed'
                };
                
                const fileKey = `user_file_${userId}_${fileId}`;
                
                const { error: fileError } = await supabase
                    .from('kv_store_54a8f580')
                    .upsert({ key: fileKey, value: fileRecord });
                
                if (fileError) {
                    throw new Error(`文件记录写入失败: ${fileError.message}`);
                }
                
                // 步骤2: 更新用户文件列表
                const userFilesKey = `user_files_${userId}`;
                
                // 先获取现有列表
                const { data: existingData } = await supabase
                    .from('kv_store_54a8f580')
                    .select('value')
                    .eq('key', userFilesKey)
                    .maybeSingle();
                
                const existingFiles = existingData?.value || { files: [] };
                
                // 添加新文件
                existingFiles.files.push({
                    id: fileId,
                    name: fileName,
                    size: 1024,
                    type: 'application/pdf',
                    uploadedAt: fileRecord.uploadedAt,
                    status: 'uploaded',
                    ocrStatus: 'completed'
                });
                
                const { error: listError } = await supabase
                    .from('kv_store_54a8f580')
                    .upsert({ key: userFilesKey, value: existingFiles });
                
                if (listError) {
                    throw new Error(`文件列表更新失败: ${listError.message}`);
                }
                
                showResult('upload-result', 
                    `文件上传模拟成功!\n` +
                    `文件ID: ${fileId}\n` +
                    `文件记录键: ${fileKey}\n` +
                    `用户文件列表键: ${userFilesKey}\n` +
                    `文件列表中的文件数: ${existingFiles.files.length}`
                );
                
            } catch (error) {
                showResult('upload-result', `模拟上传失败:\n${error.message}`, 'error');
            }
        }

        // 检查上传的文件
        async function checkUploadedFile() {
            try {
                const userId = 'user123';
                const userFilesKey = `user_files_${userId}`;
                
                const { data, error } = await supabase
                    .from('kv_store_54a8f580')
                    .select('value')
                    .eq('key', userFilesKey)
                    .maybeSingle();
                
                if (error) {
                    showResult('upload-result', `检查失败:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else if (data) {
                    const files = data.value.files || [];
                    showResult('upload-result', 
                        `用户文件检查结果:\n` +
                        `文件数量: ${files.length}\n` +
                        `文件列表: ${JSON.stringify(files, null, 2)}`
                    );
                } else {
                    showResult('upload-result', `未找到用户文件数据!\n键: ${userFilesKey}`, 'warning');
                }
            } catch (error) {
                showResult('upload-result', `检查异常:\n${error.message}`, 'error');
            }
        }

        // 清除所有测试数据
        async function clearAllTestData() {
            try {
                const { error } = await supabase
                    .from('kv_store_54a8f580')
                    .delete()
                    .like('key', '%test%');
                
                if (error) {
                    showResult('upload-result', `清除失败:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult('upload-result', '所有测试数据已清除!');
                }
            } catch (error) {
                showResult('upload-result', `清除异常:\n${error.message}`, 'error');
            }
        }

        // 页面加载时检查连接
        window.addEventListener('load', () => {
            checkDatabaseConnection();
        });
    </script>
</body>
</html>